services:
  reminder-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: reminder-server
    # 生产环境：只绑定到 127.0.0.1，通过 Nginx 反向代理对外提供服务
    # 如果需要直接访问，可以改为 "0.0.0.0:5001:5001"
    ports:
      - "127.0.0.1:5001:5001"  # 仅本地访问，通过 Nginx 反向代理
    env_file:
      - .env
    # 添加 extra_hosts 让容器能够访问宿主机的 localhost
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # 设置标志，让代码知道在 Docker 容器中运行
    environment:
      - DOCKER_CONTAINER=true
      # 生产环境：明确设置数据库主机（如果 .env 中没有设置）
      # 如果 MySQL 在宿主机上，使用 host.docker.internal
      # 如果 MySQL 在另一个容器中，使用容器名称或服务名称
      # 如果 MySQL 在远程服务器，使用实际 IP 或域名
      # - DB_HOST=host.docker.internal  # 取消注释并修改为实际值
    volumes:
      - ./logs:/var/log/reminder-server
      # 生产环境：不挂载代码目录，使用镜像中的代码（更安全）
      # - .:/app  # 开发环境才需要
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # 生产环境：限制资源使用
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

