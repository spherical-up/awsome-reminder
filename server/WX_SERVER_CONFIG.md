# 微信小程序服务器配置指南

## 一、什么是服务器配置

微信小程序的服务器配置用于接收微信服务器推送的消息和事件，例如：
- 用户发送的消息
- 用户关注/取消关注事件
- 其他事件推送

## 二、配置步骤

### 1. 登录微信公众平台

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用小程序账号登录

### 2. 进入服务器配置

1. 进入 **开发** -> **开发管理** -> **开发设置**
2. 找到 **消息推送** 部分
3. 点击 **配置**

### 3. 填写服务器配置

需要填写以下信息：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| **URL(服务器地址)** | 你的服务器接收消息的地址 | `https://www.6ht6.com/api/wx/message` |
| **Token(令牌)** | 自定义的令牌，用于验证消息 | `your_custom_token_123456` |
| **EncodingAESKey** | 消息加解密密钥（可选） | 点击"随机生成"或留空 |
| **消息加解密方式** | 选择加密方式 | 推荐选择"安全模式"或"兼容模式" |

### 4. 验证服务器

填写完成后，点击"提交"，微信会向你的服务器发送验证请求。

**验证流程：**
1. 微信服务器发送 GET 请求到你的 URL
2. 你的服务器需要验证签名并返回 `echostr` 参数
3. 验证通过后，配置生效

## 三、服务端实现

### 1. 添加消息接收接口

在 `server/app.py` 中添加消息接收接口（见下方代码）

### 2. 配置 Token

在 `.env` 文件中添加：

```env
WX_TOKEN=your_custom_token_123456
```

或者在代码中直接配置：

```python
WX_TOKEN = 'your_custom_token_123456'
```

### 3. 验证服务器

微信会发送 GET 请求验证服务器，需要实现验证逻辑。

## 四、Token 配置说明

### Token 的作用

1. **验证消息来源**：确保消息来自微信服务器
2. **防止伪造请求**：通过签名验证保证安全性

### Token 的要求

- 长度：3-32 个字符
- 字符：只能包含字母、数字
- 建议：使用随机字符串，不要使用简单密码

### 生成 Token 的方法

```bash
# 方法1：使用 openssl 生成随机字符串
openssl rand -hex 16

# 方法2：使用 Python
python3 -c "import secrets; print(secrets.token_urlsafe(16))"

# 方法3：使用在线工具
# 访问 https://www.random.org/strings/
```

## 五、消息接收接口实现

见 `server/app.py` 中的 `/api/wx/message` 接口实现。

## 六、常见问题

### Q1: 验证失败怎么办？

**A:** 检查以下几点：
1. Token 是否正确
2. URL 是否可访问（必须是 HTTPS）
3. 签名算法是否正确
4. 服务器是否返回正确的 `echostr`

### Q2: 必须使用 HTTPS 吗？

**A:** 是的，生产环境必须使用 HTTPS。开发环境可以使用 HTTP，但需要在微信开发者工具中关闭域名校验。

### Q3: Token 可以修改吗？

**A:** 可以，但修改后需要重新验证服务器。

### Q4: 消息加解密方式如何选择？

**A:**
- **明文模式**：消息不加密（仅开发环境）
- **兼容模式**：同时支持明文和加密（推荐）
- **安全模式**：消息必须加密（生产环境推荐）

## 七、测试

### 1. 本地测试

开发环境可以使用 HTTP，但需要：
1. 使用内网穿透工具（如 ngrok、natapp）
2. 在微信开发者工具中关闭域名校验

### 2. 生产环境测试

1. 确保服务器使用 HTTPS
2. 确保域名已备案（国内服务器）
3. 在微信公众平台配置服务器地址
4. 点击"提交"验证

## 八、注意事项

⚠️ **重要提示：**

1. **Token 要保密**：不要将 Token 提交到代码仓库
2. **使用 HTTPS**：生产环境必须使用 HTTPS
3. **验证签名**：所有消息都要验证签名，防止伪造
4. **及时响应**：验证请求需要在 5 秒内响应
5. **错误处理**：实现完善的错误处理和日志记录

